<!DOCTYPE html>
<!--
Solar Tracking App
Kevin Cocco
SproutLoop.com
-->
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <title>Solar Tracking App</title>
        <script src="./js/raphael-min.js" type="text/javascript"></script>
        <script src="./js/altitudeForecast.js" type="text/javascript"></script>
        <script src="./js/alignmentGauge.js" type="text/javascript"></script>
        <script src="./js/suncalc.js" type="text/javascript"></script>
        <script src="./js/jquery-2.0.3.min.js" type="text/javascript"></script>
        
        <script type="text/javascript" charset="utf-8">
            // global variables
                // geo
                var currentDate;
                var currentAzimuth;        
                var currentAltitude; 
                var sunriseStr;
                var sunriseAzimuth;
                var sunsetStr;
                var sunsetAzimuth;
                //compass
                var currentHeading = 1; 

            // Wait for device API libraries to load
            //
            document.addEventListener("deviceready", onDeviceReady, false);

            function convertDeg(degIn) {
                if (degIn>-1) 
                {degOut = 180 + degIn}
                else 
                {degOut = 180 - Math.abs(degIn)}
                return degOut;
            }

            // device APIs are available call geo
            //
            function onDeviceReady() {
                navigator.compass.getCurrentHeading(onSuccessCompass, onErrorCompass);
                startWatch();
            }

            // onSuccess: Get the current heading
            //
            function onSuccessCompass(heading) {
                //alert('Heading: ' + heading.magneticHeading);
                console.log('Heading: ' + heading.magneticHeading);
                window.heading = heading.magneticHeading;
                navigator.geolocation.getCurrentPosition(onSuccessGeo, onErrorGeo);
            }

            // onError: Failed to get the heading
            //
            function onErrorCompass(compassError) {
                alert('Compass Error: ' + compassError.code);
                console.log('Compass Error: ' + compassError.code);
            }

            // onSuccess Geolocation
            //
            function onSuccessGeo(position) {
                // ***************************************************************
                // Geocode Lat & Long
                var element = document.getElementById('geolocation');
                element.innerHTML = 'Latitude: '           + position.coords.latitude              + '<br />' +
                                    'Longitude: '          + position.coords.longitude             + '<br />' +
                                    'Altitude: '           + position.coords.altitude              + '<br />' +
                                    'Accuracy: '           + position.coords.accuracy              + '<br />' +
                                    'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
                                    'Heading: '            + position.coords.heading               + '<br />' +
                                    'Speed: '              + position.coords.speed                 + '<br />' +
                                    'Timestamp:'           + position.timestamp                    + '<br />';

                // ***************************************************************
                // Solar Azimuth and Altitude
                currentDate = new Date();
                lat = position.coords.latitude;
                lng = position.coords.longitude;

                // get position of the sun (azimuth and altitude) at today's sunrise
                currentPos = SunCalc.getPosition(currentDate, lat, lng);

                // azimuth in degrees
                currentAzimuth = convertDeg(currentPos.azimuth * 180 / Math.PI);

                // altitude in degrees
                currentAltitude = currentPos.altitude * 180 / Math.PI;

                // get today's sunlight times for current lat lng
                var times = SunCalc.getTimes(currentDate, lat, lng);

                // format sunrise time from the Date object
                sunriseStr = times.sunrise.getHours() + ':' + times.sunrise.getMinutes();

                // get position of the sun (azimuth and altitude) at today's sunrise
                sunrisePos = SunCalc.getPosition(times.sunrise, lat, lng);

                // azimuth in degrees
                sunriseAzimuth = convertDeg(sunrisePos.azimuth * 180 / Math.PI);

                // altitude in degrees
                //var sunriseAltitude = sunrisePos.altitude * 180 / Math.PI;

                // format sunset time from the Date object
                sunsetStr = times.sunset.getHours() + ':' + times.sunset.getMinutes();

                // get position of the sun (azimuth and altitude) at today's sunrise
                var sunsetPos = SunCalc.getPosition(times.sunset, lat, lng);

                // azimuth in degrees
                sunsetAzimuth = convertDeg(sunsetPos.azimuth * 180 / Math.PI);
                
                var element = document.getElementById('suncalc');
                element.innerHTML = 'CURRENT - date time: '    + currentDate            + '<br />' +
                                    '        - Azimuth: '      + currentAzimuth         + '<br />' +
                                    '        - Altitude: '     + currentAltitude        + '<br />' +
                                    'SUNRISE time: '           + sunriseStr             + '<br />' +
                                    '        - Azimuth: '      + sunriseAzimuth         + '<br />' +
                                    'SUNSET time: '            + sunsetStr              + '<br />' +
                                    '        - Azimuth: '      + sunsetAzimuth          + '<br />';
                getWeather();
                
                drawCompass(1);
                //drawAltitude(1);
            }

            // ***************************************************************
            //forecast.io weather call
            function getWeather() {
                cloudCoverArray = [];
                precipProbabilityArray = [];
                windSpeedArray =[];
                var month = (currentDate.getMonth()+1);
                if(month <= 9) {month = '0'+month};
                var day = currentDate.getDate();
                if(day <= 9) {day = '0'+day};
                var datetimestr= currentDate.getFullYear()+'-'+month+'-'+day+'T00:00:00-0000';
                $.ajax({
                    url: 'https://api.forecast.io/forecast/518926582ed0412bfdb8b861e67934c3/40.5,-111.8,'+datetimestr,
                    dataType: 'jsonp',
                    success: function(data){
                        timeStamp = new Date(data.hourly.data[0].time * 1000);
                        hour = timeStamp.getHours();
                        var element = document.getElementById('forecast');
                        element.innerHTML = 'forecast: '    +data.hourly.data[14].summary;
                        i = sunriseHour;
                        while (i<=sunsetHour) {
                            cloudCoverArray.push(string(data.hourly.data[i].cloudCover));
                            precipProbabilityArray.push(string(data.hourly.data[i].precipProbability));
                            windSpeedArray.push(string(data.hourly.data[i].windSpeed));
                            i++;
                        }
                        //alert(cloudCoverArray.join('\n'))
                        //alert(precipProbabilityArray.join('\n'))
                        //alert(windSpeedArray.join('\n'))  
                    }
                });
            }

            // ***************************************************************
            //raphaelDraw Altitude and weather
            function drawAltitude(update) {
                var windSpeedArray =["33.35", "24.6", "5.89", "5.05", "24.72", "3.44", "4.73", "8.24", "8.73", "8.08", "18.86","9.18", "18.49","8.75","6.56","40.32"]
                var precipProbabilityArray = ["0.01","0.03","0.005","0.41","0.47","0.57","0.54","0.54","0.57","0.53","0.57","0.58","0.57","0.6","0.63","0.58"]
                var cloudCoverArray = ["0.46","0.5","0.41","0.41","0.47","0.57","0.54","0.54","0.57","0.53","0.57","0.58","0.57","0.6","0.63","0.58"]
                var altitudeArray = ["-3", "5", "15", "26", "37", "49", "59", "68", "72", "67", "58", "47", "36", "25", "14", "3"];
                if (update==1) {
                    init_altitudeForecast("altitudeForecast");
                }
                altitudeForecast(update,"5:59","20:50","15:15",60,altitudeArray,-21600,cloudCoverArray,precipProbabilityArray,windSpeedArray);
            }
            
            // ***************************************************************
            //raphaelDraw Alignment compass
            function drawCompass(update) {
            // alignmentGauge(refresh, azimuth, heading, sunRiseAngle, sunSetAngle, sunRiseTime, sunSetTime)
                if (update==1) {
                    init_alignmentGauge("alignmentGauge");
                    alignmentGauge(1,200,250,64,292,"5:67","9:11");
                }
                alignmentGauge(0,95,13.123,64,292,"5:32","9:15");
                //alignmentGauge(update,currentAzimuth,currentHeading,sunriseAzimuth,sunsetAzimuth,sunriseStr,sunsetStr);
            }

            // onError Callback receives a PositionError object
            //
            function onErrorGeo(error) {
                alert('code: '    + error.code    + '\n' +
                      'message: ' + error.message + '\n');
            }


            // The watch id references the current `watchHeading`
            var watchID = null;

            // Start watching the compass
            //
            function startWatch() {
                // Update compass every 3 seconds
                var options = { frequency: 1000 };
                watchID = navigator.compass.watchHeading(onSuccess, onError, options);
            }

            // Stop watching the compass
            //
            function stopWatch() {
                if (watchID) {
                    navigator.compass.clearWatch(watchID);
                    watchID = null;
                }
            }

            // onSuccess: Get the current heading
            //
            function onSuccess(heading) {
                var element = document.getElementById('heading');
                element.innerHTML = 'Heading: ' + heading.magneticHeading;
                currentHeading = heading.magneticHeading;
                // alignmentGauge(refresh, azimuth, heading, sunRiseAngle, sunSetAngle, sunRiseTime, sunSetTime)
                //alignmentGauge(0,200,heading.magneticHeading,64,292,"5:67","9:11");
                drawCompass(0);
                
            }

            // onError: Failed to get the heading
            //
            function onError(compassError) {
                alert('Compass error: ' + compassError.code);
            }
    

       </script>
    </head>
    <body>
      
        
        <div id="altitudeForecast"></div>
        <div id="alignmentGauge"></div>
        <br>
        <h1> GEOLOCATION INFO: </h1>
        <p id="geolocation">Finding geolocation...</p>
        <br>
        <h1> FORECAST INFO: </h1>
        <p id="forecast">forecast...</p>
        <br>
        <h1> SUNCALC INFO: </h1>
        <p id="suncalc">suncalc...</p>
        <br>
        <h1> HEADING: </h1>
        <div id="heading">Waiting for heading...</div>
        <button onclick="startWatch();">Start Watching</button>
        <button onclick="stopWatch();">Stop Watching</button>
<!-- 
        <div class="app">
            <h1>PhoneGap</h1>
            <div id="deviceready" class="blink">
                <p class="event listening">Connecting to Device</p>
                <p class="event received">Device is Ready</p>
            </div>
        </div>
-->
        <script type="text/javascript" src="phonegap.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            app.initialize();
        </script>
    </body>
</html>
